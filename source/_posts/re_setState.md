---
title: æ­ç§˜setStateæœºåˆ¶
date: 2019-01-27 19:34:45
tags:
- setState
categories:
- å‰ç«¯,react
---


## å¼€ç¯‡
è¦è¯´`React`è®¾è®¡ä½“ç°äº†å“åº”å¼ç¼–ç¨‹æ€æƒ³
> UI=f(state) 

[ç¨‹å¢¨Morgan](https://www.zhihu.com/people/morgancheng/activities)çš„æ€»ç»“çœŸæ˜¯æ°åˆ°å¥½å¤„

`state`äº`React`å¾ˆé‡è¦ï¼Œ`setState`ä½œä¸ºç®¡ç†`state`çš„é‡è¦æ–¹æ³•è‡ªç„¶ä¹Ÿæ˜¯å¤´ç­‰å…¬æ°‘

å½“ç„¶äº†ï¼Œå¦‚æœåªæ˜¯ç®€å•ç”¨æ³•ï¼ŒAPIè¶³å¤Ÿäº†ï¼Œä½ çŸ¥é“å¦‚ä½•è®¾ç½®ï¼Œå¦‚ä½•æ›´æ–°ï¼Œæˆ–è®¸èƒ½è§£å†³çœ¼å‰çš„éœ€æ±‚ï¼Œä½†æ˜¯éœ€æ±‚ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå¯èƒ½ä¼šè¢«åŠ¨é™·å…¥`setState`æ€ªåœˆ

åœ¨å“ªé‡Œè·Œå€’å°±æŠŠå“ªé‡Œä¹°ä¸‹æ¥ï¼Œè¢«å‘äº†ä¹‹åï¼Œç—›å®šæ€ç—›å†³å®šç ”ç©¶ä¸‹`setState`æ€ªè±¡ï¼Œæœ€åå‘ç° reactçœŸæ˜¯åšå¤§ç²¾æ·±

<font color="red">æ–‡ç« å¤ªå¤ªå¤ªé•¿äº†ï¼Œä¸å¤ªæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æ‹‰åˆ°æœ€åæ€»ç»“ï¼Œä¹Ÿèƒ½é¿å…å…¥å‘</font>

## å¼•å‡ºé—®é¢˜

**å¦‚æœé¢è¯•å®˜é—®ä½ **

1. setState æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ
2. å®ƒå¯èƒ½æ˜¯åŒæ­¥çš„å—ï¼Ÿå¦‚æœå¯èƒ½çš„è¯å¦‚ä½•å®ç°åŒæ­¥æ›´æ–°stateï¼Ÿ


å¦‚æœæ˜¯çœ‹è¿™ç¯‡æ–‡ç« ä¹‹å‰ æˆ‘çš„ç­”æ¡ˆå¯èƒ½æ˜¯è¿™æ ·å„¿
1. å®ƒæ˜¯å¼‚æ­¥çš„ ä¸èƒ½ç«‹é©¬æ‹¿åˆ°ç»“æœ
2. emm....

## è§£å†³é—®é¢˜
<!--æœ€å¥½çš„æ–¹å¼å°±æ˜¯å¸¦ç€ç–‘é—®çœ‹æºç ï¼ˆåŸºäºç‰ˆæœ¬<font color="red">16.4.1</font>ï¼‰ï¼Œç›¸ä¿¡æˆ‘ è°ƒè¯•å¤§æ³•å¥½-->

å¯èƒ½ä¼šæœ‰ç–‘é—®çš„å‡ ä¸ªé—®é¢˜.
### 1. ä¸ºä»€ä¹ˆè¦ç”¨setStateæ›´æ–°stateä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Ÿ
å…ˆæ›´æ­£ä¸€ä¸ªè§‚ç‚¹ æ˜¯å¯ä»¥é€šè¿‡`this.state`å¯¹è±¡ä¿®æ”¹stateçš„ ä¹Ÿç¡®å®èƒ½æ”¹å˜çŠ¶æ€ï¼Œä½†æ˜¯ä¸èƒ½é©±åŠ¨uiæ›´æ–°ï¼ˆä¸èµ°renderï¼‰é‚£.. æœ‰ä»€ä¹ˆæ„ä¹‰
### 2. setStateæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ
setStateæ˜¯åŒæ­¥æ‰§è¡Œçš„ ä½†æ˜¯stateå¹¶ä¸ä¸€å®šä¼šåŒæ­¥æ›´æ–°ï¼ˆå¼‚æ­¥æ›´æ–°ï¼‰,è¿™æ˜¯ç»“è®º

é’ˆå¯¹è¿™ä¸ªé—®é¢˜ è®©æˆ‘ä»¬å¸¦ç€é—®é¢˜å»æºç ï¼ˆåŸºäºç‰ˆæœ¬<font color="red">16.4.1</font>ï¼‰ä¸­å¯»æ‰¾ç­”æ¡ˆ

-------

#### <font color=green>**åœºæ™¯ä¸€ï¼ˆåˆæˆäº‹ä»¶ä¸­è°ƒç”¨setStateï¼‰**</font>

ç‚¹å‡»æŒ‰é’®å®ç°åŠ ä¸€çš„æ“ä½œ

```
...
onClick = ()=> {
   this.setState({
       val: this.state.val + 1
   })
   console.log('onClick', this.state.val);
 }
 ...
 render(){
console.log('render', this.state.val);
 <button onClick={this.onClick}>åŠ 1</button>
 }
 

```
é¦–å…ˆ è¿™æ˜¯<font color=red>åˆæˆäº‹ä»¶</font>ä¸­æ“ä½œ`state`,

**äº†è§£ä»€ä¹ˆæ˜¯åˆæˆäº‹ä»¶ï¼Ÿ**
> reactä¸ºäº†è§£å†³è·¨å¹³å°ï¼Œå…¼å®¹æ€§é—®é¢˜ï¼Œè‡ªå·±å°è£…äº†ä¸€å¥—äº‹ä»¶æœºåˆ¶ï¼Œä»£ç†äº†åŸç”Ÿçš„äº‹ä»¶ï¼Œåƒåœ¨jsxä¸­å¸¸è§çš„onClickã€onChangeè¿™äº›éƒ½æ˜¯åˆæˆäº‹ä»¶

ç›¯ç€è¿™å¼ ç½‘ç»œç›—å›¾ï¼Œç”»çš„å®Œå…¨ç¬¦åˆæˆ‘çš„é¢„æœŸï¼Œå…ˆæœ‰ä¸ªæ¦‚è§ˆï¼Œä¸‹æ–‡ä¼šè·Ÿè¸ªè§£é‡Š

![setStateçš„æ›´æ–°è¿‡ç¨‹](/images/setState/setState__.jpg)

å½“ä½ ç‚¹å‡»`onClick`æ—¶

* ç¬¬ä¸€é˜¶æ®µ ï¼ˆå¯¹åˆæˆäº‹ä»¶çš„å‰æœŸå¤„ç†ï¼‰

reactä¼šåœ¨æ­£å¼`setState`å‰æ‰§è¡Œä¸€å †preé’©å­å‡½æ•°(<font color="red">å¤§éƒ¨åˆ†éƒ½ä¸éœ€è¦å…³å¿ƒ</font>),ä½ å¯ä»¥åœ¨chromeè°ƒè¯•å°æˆ–è€…`console.trace()`è¿½è¸ªåˆ°
åƒè¿™æ ·å„¿ğŸ‘‡
![trace](/images/setState/trace.png)
è¿™äº›éƒ½æ˜¯reactçš„å‰æœŸå¤„ç† è¿™ä¸ªè¿‡ç¨‹ä½ åªéœ€è¦å…³å¿ƒğŸ‘‡

![preé’©å­](/images/setState/pre11.png)

å¾—åˆ°çš„ä¿¡æ¯
isBatchingUpdatesé»˜è®¤ä¸ºfalse,åœ¨è¿™é‡Œ(æŸä¸€ä¸ªpreé’©å­å‡½æ•°ä¸­è¢«ç½®ä¸ºtrueäº†)ï¼Œåˆ’é‡ç‚¹ï¼Œä»¥åè¦è€ƒçš„ æ­¤æ—¶ç¨‹åºèµ°çš„æ˜¯<font color="red">tryåˆ†æ”¯</font>

è‡³æ­¤ï¼Œå‰æœŸå¤„ç†ç»“æŸ

* ç¬¬äºŒé˜¶æ®µï¼ˆsetStateäº‹ä»¶çš„å¤„ç†ï¼‰

çº¢æ¡†éƒ¨åˆ†æ˜¯`setState`é€»è¾‘çš„è°ƒç”¨æ ˆï¼Œæ‰§è¡Œåˆ°`requestWork`æ–¹æ³•æ—¶ä¼šäºŒæ¬¡åˆ¤æ–­ å¦‚ä¸‹å›¾ğŸ‘‡
![sasas](/images/setState/sasas.png)

äºŒé˜¶æ®µå®Œ

* ç¬¬ä¸‰é˜¶æ®µï¼ˆé‡ç½®posté’©å­,æ›´æ–°state æ¸²æŸ“uiæ“ä½œï¼‰

æ¥ä¸Šæ–‡ï¼Œé‚£ä¹ˆæˆ‘æƒ³çŸ¥é“å®ƒä¼šreturnåˆ°å“ªé‡Œå‘¢
é€šè¿‡è¿½è¸ªå‘ç° ä¼šèµ°ä½ ä¸»è¿›ç¨‹é‡Œçš„`console`è¯­å¥
![stateå»¶è¿Ÿæ›´æ–°](/images/setState/state_delay.png)
**è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´setStateæ›´å¼‚æ­¥çš„**
ä¸Šæ–‡ä¸­æåˆ°æˆ‘ä»¬ç°åœ¨ä»ç„¶å¤„åœ¨tryåˆ†æ”¯ä¸­ï¼Œè€Œåœ¨ finally ä¸­æ‰ä¼šæ›´æ–°`state`å¹¶ä¸”æ¸²æŸ“åˆ°UIä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬å¾—åˆ°çš„ä»ç„¶æ˜¯`æ›´æ–°å‰çš„ state` å€¼ï¼Œè¿™å°±å¯¼è‡´äº†`æ‰€è°“çš„"å¼‚æ­¥"`,ä¸ºä»€ä¹ˆè¦ç”¨`""`å·,å› ä¸ºè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬çš„æœ¬æ„ï¼Œæ˜¯`reactä¸ºäº†æ€§èƒ½ç€æƒ³ç§è‡ªåšçš„å¤„ç†`

-------

æ¥ç€å¾€ä¸‹èµ°ï¼š
![ssssww](/images/setState/sssswww.png)
æœ€ç»ˆè¿˜ä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•
è¿™ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸ª try finally è¯­æ³•, åˆ°è¿™é‡Œ æˆ‘ä»¬çŸ¥é“äº†åŸæ¥returnåˆ°äº†è¿™ä¸ªfn
ç»§ç»­ğŸ‘‡
![posté’©å­](/images/setState/post0.png)
![ui](/images/setState/ui.png)

renderä¹‹å åˆæˆäº‹ä»¶ä¸­setStateçš„é€»è¾‘å°±ç»“æŸäº†

-------

#### <font color=green>**åœºæ™¯äºŒï¼ˆç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨setStateï¼‰**</font>

å®é™…ä¸Šä¸åœºæ™¯ä¸€åªåœ¨ç¬¬ä¸€é˜¶æ®µä¸åŒï¼ˆæ²¡æœ‰å¯¹åˆæˆäº‹ä»¶çš„å„ç§å¤„ç†ï¼‰æˆ‘ä»¬å¯èƒ½æƒ³åœ¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸä¸­èŠä¸‹stateçš„æ›´æ–°çŠ¶å†µ

æˆ‘ä»¬ç…§ä¾‹å…ˆæ¥ä¸ªå°demo å†æ¥åˆ†æä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·å„¿çš„ç»“æœ

```
state = {
   val:0,
   name:'yishu',
   age:18
}
 componentWillMount(){
      this.setState({val:this.state.val+1});
      console.log('componentWillMountç¬¬ä¸€æ¬¡è¾“å‡º',this.state.val)
      this.setState({val:this.state.val+1});
      console.log('componentWillMountç¬¬äºŒæ¬¡è¾“å‡º',this.state.val)
    }
     componentDidMount(){
      this.setState({
            val: this.state.val + 1,
            name:'ğŸ¶'
        });
        console.log('componentDidMountç¬¬ä¸€æ¬¡æ‰§è¡Œ', this.state.val)
        this.setState({
            val: this.state.val + 1,
            name:'ğŸ±',
            age:81
        });
        console.log('componentDidMountç¬¬äºŒæ¬¡è¾“å‡º', this.state.val)
     }
     
     componentDidUpdate(){
        console.log('componentDidUpdateæ‰§è¡Œ',this.state.val)
    }
render(){
      if(this.state.val !==0){
            console.log('renderæ‰§è¡Œ',this.state)
        }
  <p>å½“å‰çš„å€¼:{this.state.val}</p>
  <p>ä½ çš„åå­—:{this.state.name}</p>
  <p>èŠ³é¾„:{this.state.age}</p>
}

```

ç›´æ¥ç»™å‡ºç»“æœ

![component_state](/images/setState/component_state.png)
å…¶å®ç»è¿‡å„ç§APIçš„ç†é™¶ï¼Œä¸è¿è¡Œä¹Ÿèƒ½çŸ¥é“ç»“æœ,æ—¢ç„¶æ‘Šå¼€æ¥è®²ï¼Œå°±æ¯”è¾ƒæƒ³çŸ¥é“ä¸ºä»€ä¹ˆã€‚

æŒ‰ç…§æµç¨‹ ï¼Œå…ˆæ¥ä¸€å¼ è°ƒç”¨æ ˆé¸Ÿç°å›¾ï¼ˆç½‘å›¾ï¼‰

![é’©å­å‡½æ•°ä¸­setStateçš„è°ƒç”¨æ ˆ](/images/setState/gouzihanshu.jpg)
è¿˜æ˜¯ä¸‰ä¸ªé˜¶æ®µ


* ç¬¬ä¸€é˜¶æ®µ
![did](/images/setState/did.png)

* ç¬¬äºŒé˜¶æ®µ
![2121233434](/images/setState/2121233434.png)
åˆ°ç°åœ¨å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œä¸åœºæ™¯ä¸€ä¸åŒçš„æ˜¯ èµ°çš„æ˜¯`requestWork`ä¸­çš„ç¬¬ä¸€ä¸ª`if`åˆ†æ”¯,åœºæ™¯ä¸€ï¼ˆç¬¬äºŒä¸ªifåˆ†æ”¯ï¼‰ä¸ç®¡å“ªç§æƒ…å†µ ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ é‚£å°±æ˜¯ä¸ä¼šèµ°åˆ°ä¸‹é¢çš„åŒæ­¥æ›´æ–°åˆ†æ”¯ å¹¶ä¸” ä¸¤ç§æƒ…å†µéƒ½è¿˜åªæ˜¯åœ¨**try**æ¨¡å—ä¸­æ‰§è¡Œ å†å¾€ä¸‹çš„æµç¨‹å‚è€ƒåœºæ™¯ä¸€

* ç¬¬ä¸‰é˜¶æ®µ
åŒåœºæ™¯ä¸€

å…³äºè¿™ä¸€åœºæ™¯ èƒŒç€
<font color="red">`render`ä¹‹å‰çš„ç”Ÿå‘½å‘¨æœŸæ‹¿åˆ°çš„éƒ½æ˜¯æ›´æ–°ä¹‹å‰çš„å€¼ï¼Œrenderä¹‹åæ‰§è¡Œçš„æ‰èƒ½æ‹¿åˆ°æœ€æ–°çš„å€¼ æ¯”å¦‚ `componentDidUpdate`</font>

-------

### 3. setStateå¯ä»¥å˜æˆåŒæ­¥æ›´æ–°å—ï¼Ÿ å¦‚æœå¯ä»¥çš„è¯ æ€ä¹ˆåšæ‰èƒ½è·å–æœ€æ–°çš„å€¼ï¼Ÿ

é¢è¯•å®˜è¿™ä¹ˆé—®çš„è¯ é€šå¸¸éƒ½æ˜¯å¯ä»¥ ğŸ˜‚
é‚£æˆ‘ä»¬å¦‚ä½•åš
å®è·µä¸­ä¸€èˆ¬æ¯ä¸ªäººéƒ½æœ‰ä¸€åˆ°ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œè¿™é‡Œåˆ—ä¸¾ä¸­å¤„ç†æ–¹æ¡ˆ å¹¶å°†åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­æ·±å…¥ç ”ç©¶ ä¸ºä»€ä¹ˆ å®ƒ å¯ä»¥.

* åœ¨**åŸç”Ÿäº‹ä»¶**ä¸­è°ƒç”¨`setState`å‡½æ•°
* åˆ©ç”¨setStateå›è°ƒå‡½æ•°
* setTimeoutç­‰å¼‚æ­¥æ“ä½œä¸­è°ƒç”¨`setState`å‡½æ•°
* æœ€è¿‘åˆšè¢«ç§è‰çš„å‡½æ•°å¼setstateç”¨æ³•
* componentDidUpdateä¸­è·å–

åè¯é‡Šä¹‰ï¼š
**åŸç”Ÿäº‹ä»¶**ï¼šæŒ‡éreactåˆæˆäº‹ä»¶ï¼ŒåŸç”Ÿè‡ªå¸¦çš„äº‹ä»¶ç›‘å¬ `addEventListener` ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç”¨åŸç”Ÿ`jsã€jq`ç›´æ¥ `document.querySelector().onclick` è¿™ç§ç»‘å®šäº‹ä»¶çš„å½¢å¼

-------

#### åœ¨**åŸç”Ÿäº‹ä»¶**ä¸­è°ƒç”¨`setState`å‡½æ•°


ä¸€ä¸ªå°demo

```
state = {
   val:0
}
componentDidMount = () =>{
 document.querySelector('#btn-raw').addEventListener('click', this.onClick);
}

onClick = ()=> {
   this.setState({
       val: this.state.val + 1
   });
   console.log('onClick', this.state.val);
 }
 
render(){
 if(this.state.val !==0){
            console.log('renderæ‰§è¡Œ',this.state)
        }
 <button id="btn-raw">Increment </button>
}
```
è¿è¡Œç»“æœ
![js](/images/setState/js.png)
æ„æ–™ä¹‹ä¸­

æŒ‰ç†æ¥è¯´è¿˜éœ€è¦å¼ é¸Ÿç°å›¾ åœ¨è¿™é‡Œ ğŸ‘‡


![åŸç”Ÿäº‹ä»¶çš„setState](/images/setState/js0setState.jpg)

å…¶å®åº”è¯¥å·²ç»æŒºæ¸…æ™°äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯åœ¨è°ƒè¯•å™¨é‡Œèµ°ä¸€ä¸‹

* ç¬¬ä¸€é˜¶æ®µï¼ˆsetStateé€»è¾‘ä¹‹å‰çš„å¤„ç†ï¼‰

![js_xzs](/images/setState/js_xzs.png)
ç”»é£çªå˜ï¼Œè°ƒç”¨æ ˆå†…ä¸å†æ‰§è¡Œä¸€å †çœ‹ä¸æ‡‚çš„preé’©å­å‡½æ•°äº†
ç®€å•çš„ç†è§£ä¸º ç”¨åŸç”Ÿäº‹ä»¶è°ƒç”¨æ—¶ ä¸å—reactæ§åˆ¶äº† ä¹Ÿå°±æ²¡åŠæ³•é’ˆå¯¹å®ƒæ‰§è¡Œä¸€å †å‡½æ•°ï¼Œç›´æ¥èµ°setStateçš„é€»è¾‘äº†

* ç¬¬äºŒé˜¶æ®µï¼ˆsetStateæ‰§è¡Œé€»è¾‘ï¼‰

![js999](/images/setState/js999.png)

èµ°äº†ç¬¬ä¸‰ä¸ª`if`åˆ†æ”¯ åŒæ­¥æ›´æ–°äº†ï¼ˆæ‰§è¡Œäº†render å†åœ¨clickå‡½æ•°ä¸­æ‰“å°çš„ æ‰€ä»¥æ‹¿åˆ°äº†æœ€æ–°å€¼ï¼‰

* ç¬¬ä¸‰é˜¶æ®µ

å‚è€ƒåœºæ™¯ä¸€

-------

#### åˆ©ç”¨setStateå›è°ƒå‡½æ•°
APIå°±ä¸å¤šè¯´äº†
 
```
 this.setState({
       val:this.state.val + 1
        },()=>{
          console.log('cllback',this.state.val);
})
```
åŸç†ï¼šå›è°ƒå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå…¶å®renderå‡½æ•°å·²ç»è¢«è°ƒç”¨è¿‡äº† å‚è€ƒ`demo`çš„æ‰§è¡Œç»“æœ

-------
#### setTimeoutç­‰å¼‚æ­¥æ“ä½œä¸­è°ƒç”¨`setState`å‡½æ•°

å®é™…ä¸Š è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„åœºæ™¯ï¼Œä½ å¯ä»¥åœ¨åˆæˆäº‹ä»¶ä¸­ è°ƒç”¨ `setTimeout` ï¼Œå¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨ `setTimeout` ï¼Œä¹Ÿå¯ä»¥åœ¨åŸç”Ÿäº‹ä»¶`setTimeout`ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªä¸ªåœºæ™¯ä¸‹ï¼ŒåŸºäº `event loop`çš„æ¨¡å‹ä¸‹ï¼Œ setTimeout ä¸­é‡Œå» setState æ€»èƒ½æ‹¿åˆ°æœ€æ–°çš„stateå€¼

ä¸€ä¸ªdemo ğŸ‘‡

```
this.state = {
       val:0,
       name:'yishu',
       age:18
   }
       componentDidMount(){
        // // debugger;
        // // ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨---------------
        this.setState({
            val: this.state.val + 1,
            name:'ğŸ¶'
        });
        console.log('componentDidMountç¬¬ä¸€æ¬¡æ‰§è¡Œ', this.state.val)
        this.setState({
            val: this.state.val + 1,
            name:'ğŸ±',
            age:81
        });
        console.log('componentDidMountç¬¬äºŒæ¬¡è¾“å‡º', this.state.val)

        setTimeout(() => {
            console.log('å¼€å§‹setTimeout', this.state.val)
            this.setState({
                val: this.state.val + 1
            });
            console.log('setTimeoutç¬¬ä¸€æ¬¡æ‰§è¡Œ', this.state.val)
            this.setState({
                val: this.state.val + 1
            });
            console.log('setTimeoutç¬¬äºŒæ¬¡æ‰§è¡Œ', this.state.val)
        }, 0)

        this.setState({
            val: this.state.val + 1
        });
        console.log('componentDidMountç¬¬ä¸‰æ¬¡è¾“å‡º', this.state.val)        
    }
render(){
if(this.state.val !==0){
            console.log('renderæ‰§è¡Œ',this.state)
        }
 <p>å½“å‰çš„å€¼:{this.state.val}</p>
}
```
![setTimeout](/images/setState/setTimeout.png)
ä¸Šè¿°ç»“æœï¼Œå¦‚æœä½ äº†è§£<font color="red">jsäº‹ä»¶å¾ªç¯ï¼ˆ event loopï¼‰</font>çš„æœºåˆ¶ å°±å¤ªç®€å•äº†

é»˜è®¤ä½ å·²ç»é˜…è¯»è¿‡å…¨æ–‡çš„ä¸ŠåŠéƒ¨åˆ† äº†è§£äº† `setState`é€»è¾‘éƒ½æ˜¯åœ¨**try**æ¨¡å—ä¸­æ‰§è¡Œçš„æ˜¯åœ¨ try ä»£ç å—ä¸­,å½“ä½  try ä»£ç å—æ‰§è¡Œåˆ° `setTimeout` çš„æ—¶å€™ï¼ŒæŠŠå®ƒä¸¢åˆ°**å®šæ—¶å™¨è§¦å‘çº¿ç¨‹(æµè§ˆå™¨æä¾›çš„çº¿ç¨‹)**å»ç»´æŠ¤ï¼Œå¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œï¼Œå…ˆæ‰§è¡Œçš„ `finally` ä»£ç å—ï¼Œç­‰ finally æ‰§è¡Œå®Œäº†ï¼Œ `isBatchingUpdates` åˆå˜ä¸ºäº† `false` ï¼Œå¯¼è‡´æœ€åå»æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ setState æ—¶å€™ï¼Œ requestWork èµ°çš„æ˜¯å’ŒåŸç”Ÿäº‹ä»¶ä¸€æ ·çš„ `expirationTime === Sync if`åˆ†æ”¯ï¼Œæ‰€ä»¥è¡¨ç°å°±ä¼šå’ŒåŸç”Ÿäº‹ä»¶ä¸€æ ·ï¼Œå¯ä»¥åŒæ­¥æ‹¿åˆ°æœ€æ–°çš„`state`å€¼ã€‚

å…³äºjsäº‹ä»¶å¾ªç¯ åˆæ˜¯å¦ä¸€ä¸ªæ¨¡å—å„¿çš„ä¸œè¥¿ å€¼å¾—å•å¼€ä¸€ç« å»ç ”ç©¶ï¼Œè¿™é‡Œå°±ä¸å†ç»†è¯´äº† æ„Ÿå…´è¶£çš„åŒå­¦ å¯ç§»æ­¥
[jsåˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„](http://maying.ink/2018/11/17/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3js%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/#more) å¯»æ‰¾ç­”æ¡ˆ

-------

### 4. å‡½æ•°å¼setStateç”¨æ³•
æˆ‘åœ¨æƒ³ æ€ä¹ˆæ‰èƒ½æ›´å¥½å¼•å‡ºè¿™ä¸ªå¤§å½©è›‹ï¼Œé‚£ä¾¿åˆæ¶‰åŠåˆ°å¦ä¸€ä¸ªé—®é¢˜
ä»¥ä¸Šæ–‡ç« ä¸­æˆ‘ä»¬ä¸ºäº†è¯´æ˜`setStateæ‰§è¡Œçš„å¤§æµç¨‹` æœ‰ä¸€ä¸ªå®é™…å­˜åœ¨å´æ²¡æåŠçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯`setStateçš„æ‰¹é‡æ›´æ–°`

ç±»ä¼¼è¿™æ ·å„¿çš„ä»£ç 

```
      //...
      this.setState({val: this.state.val + 1});
      console.log('componentDidMountç¬¬ä¸€æ¬¡æ‰§è¡Œ', this.state.val)
      this.setState({val: this.state.val + 1});
      console.log('componentDidMountç¬¬äºŒæ¬¡æ‰§è¡Œ', this.state.val)
      this.setState({val: this.state.val + 1});
      console.log('componentDidMountç¬¬ä¸‰æ¬¡æ‰§è¡Œ', this.state.val)
      //...
```
å¾—åˆ°çš„æ‰§è¡Œç»“æœ
![rende](/images/setState/render.png)

APIå‘Šè¯‰æˆ‘å¯ä»¥æ¥å—ï¼Œä½†æ˜¯æœ‰ç‚¹ç‚¹æ‡µ å‘ç”Ÿäº†ä»€ä¹ˆ... emm
å‡å¦‚è¿™ä¹ˆå†™ ä¼šä¸ä¼šæ›´æ¸…æ™°ğŸ‘‡

```
  const currentCount = this.state.count;
  this.setState({count: currentCount + 1});
  this.setState({count: currentCount + 1});
  this.setState({count: currentCount + 1});
```
å¯¹çš„ ä½ æ¯æ¬¡è®¾ç½®çš„éƒ½æ˜¯åŒä¸€ä¸ªå€¼
setStateå¤šæ¬¡,re-renderä¸€æ¬¡ï¼Œå¤šæ¬¡åŒæ­¥æ‰§è¡Œçš„`setState`ï¼Œä¼šè¿›è¡Œåˆå¹¶ï¼Œç±»ä¼¼äº`Object.assign`,ç›¸åŒçš„`key`ä¼šè¢«è¦†ç›– æ‰€ä»¥ç»“æœä¸º<font color="red">1</font>

ä¸ºäº†ä¸åé¢˜ å®ç°è¿‡ç¨‹æš‚æ—¶çœç•¥,æ¥å—è¿™ä¸ªç»“è®º,è®©æˆ‘ä»¬çœ‹å‡½æ•°å¼setStateç”¨æ³•

<font color="red">å¦‚æœä¼ é€’ç»™this.setStateçš„å‚æ•°`ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œæ˜¯ä¸€ä¸ªå‡½æ•°` é‚£å°±å®Œå…¨ä¸ä¸€æ ·å„¿äº†</font>

ä¸€ä¸ªå°ğŸŒ°ä½“éªŒä¸‹ç¥å¥‡çš„æ•ˆæœ

```
componentDidMound = () =>{
        console.log('å‚æ•°ä¸ºå‡½æ•°ç¬¬ä¸€æ¬¡æ‰§è¡Œ',this.state.val)
        this.setState(this.increment);
        console.log('å‚æ•°ä¸ºå‡½æ•°ç¬¬äºŒæ¬¡æ‰§è¡Œ',this.state.val)
        this.setState(this.increment);
        console.log('å‚æ•°ä¸ºå‡½æ•°ç¬¬ä¸‰æ¬¡æ‰§è¡Œ',this.state.val)
        this.setState(this.increment);
        console.log('å‚æ•°ä¸ºå‡½æ•°ç¬¬å››æ¬¡æ‰§è¡Œ',this.state.val)
}
   /**
     * @description incrementå‡½æ•°å¹¶ä¸å»ä¿®æ”¹ç»„ä»¶çŠ¶æ€ï¼Œåªæ˜¯æŠŠâ€œå¸Œæœ›çš„çŠ¶æ€æ”¹å˜â€è¿”å›ç»™Reactï¼Œç»´æŠ¤çŠ¶æ€è¿™äº›è‹¦åŠ›æ´»å®Œå…¨äº¤ç»™Reactå»åšã€‚
     * params  stateï¼šå½“å‰çš„state
     * params  propsï¼šå½“å‰çš„props
     * @return å¯¹è±¡ä»£è¡¨ä¹‹å‰ä½ æƒ³ç»™this.setStateä¼ é€’çš„å‚æ•° æ¯”å¦‚ä½ è®¤ä¸ºç¬¬ä¸€æ¬¡ä¼ 0 ç¬¬äºŒæ¬¡ä¼ 1 
     * @memberof SetState
     */
    increment = (state, props) => {
        // è®¡ç®—è¿™ä¸ªå¯¹è±¡çš„æ–¹æ³•æœ‰äº›æ”¹å˜ï¼Œä¸å†ä¾èµ–äºthis.stateï¼Œè€Œæ˜¯ä¾èµ–äºè¾“å…¥å‚æ•°stateã€‚
        console.log('---state',state) 
        return {val: state.val + 1}; //åŒæ ·æ˜¯æŠŠçŠ¶æ€ä¸­çš„countåŠ 1ï¼Œä½†æ˜¯çŠ¶æ€çš„æ¥æºä¸æ˜¯this.stateï¼Œè€Œæ˜¯è¾“å…¥å‚æ•°stateã€‚
      }
```
![fn_state](/images/setState/fn_state.png)
ä»”ç»†çœ‹ä¸‹ä»£ç ä¸­çš„æ³¨é‡Šéƒ¨åˆ†
ç»“è®ºï¼š
å¯¹äºå¤šæ¬¡è°ƒç”¨å‡½æ•°å¼setStateçš„æƒ…å†µï¼ŒReactä¼šä¿è¯è°ƒç”¨æ¯æ¬¡incrementæ—¶ï¼Œstateéƒ½å·²ç»åˆå¹¶äº†ä¹‹å‰çš„çŠ¶æ€ä¿®æ”¹ç»“æœã€‚
ä½†æ˜¯ åœ¨`increment`å‡½æ•°è¢«è°ƒç”¨æ—¶`ï¼Œthis.state`å¹¶æ²¡æœ‰è¢«æ”¹å˜ï¼Œä¾ç„¶è¦ç­‰åˆ°`render`å‡½æ•°è¢«é‡æ–°æ‰§è¡Œæ—¶æ‰è¢«æ”¹å˜ï¼Œä¹Ÿæ²¡æœ‰æ¨ç¿»ä¸Šæ–‡çš„ç»“è®º çœŸå¥½ã€‚

APIçš„è®¾è®¡ç¬¦åˆå‡½æ•°å¼ç¼–ç¨‹æ€æƒ³ï¼Œå¼€å‘è€…ç¼–å†™æ— å‰¯ä½œç”¨çš„å‡½æ•° increment å¹¶ä¸ä¼šå»æ”¹å˜ç»„ä»¶çŠ¶æ€ï¼Œåªæ˜¯æŠŠâ€œå¸Œæœ›çš„çŠ¶æ€æ”¹å˜â€è¿”å›ç»™Reactï¼Œç»´æŠ¤çŠ¶æ€è¿™äº›è‹¦åŠ›æ´»å®Œå…¨äº¤ç»™Reactå»åšã€‚
ä¹Ÿæ­£æ˜¯ æµç¨‹çš„æ§åˆ¶æƒäº¤ç»™äº†Reactï¼Œæ‰€ä»¥Reactæ‰èƒ½åè°ƒå¤šä¸ªsetStateè°ƒç”¨çš„å…³ç³»ã€‚

### 4. æ‰‹åŠ¨é¿å…setStateçš„ä¸å½“è°ƒç”¨å¸¦æ¥çš„æ€§èƒ½é—®é¢˜
åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå°±æ¸…æ¥šäº†setStateæ‰§è¡Œæœºåˆ¶ï¼Œé‚£ä¹ˆ æˆ‘ä»¬åº”è¯¥æ€æ ·å„¿åˆ©ç”¨è‡ªå·±çš„çŸ¥è¯†æ‰‹åŠ¨ä¼˜åŒ–é¡µé¢æ€§èƒ½å‘¢

è¿™é‡Œåˆ—ä¸¾äº†å‡ æ¡

* é™¤äº†ç‰¹æ®Šéœ€æ±‚ å°½é‡ä¸è¦åœ¨éåˆæˆäº‹ä»¶ä¸­è°ƒç”¨`setState` è¿™æ ·å„¿ä¼šå¤±æ§ å˜æˆçœŸçš„åŒæ­¥æ›´æ–°äº† æ¯æ¬¡æ›´æ–°éƒ½ä¼šèµ°render èµ°renderå°±ä¸å¯é¿å…çš„æ¶‰åŠåˆ° `diffå¯¹æ¯”`.. æ›´æ–°è¿‡ç¨‹å¾ˆé¢‘ç¹ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚
* ä¸è¦åœ¨ `shouldComponentUpdate` å’Œ `componentWillUpdate` ä¸­è°ƒç”¨ setState ä¼šé€ æˆå¾ªç¯
![xunhuan](/images/setState/xunhuan.jpg)


## æ€»ç»“
* setStateä¸ä¼šç«‹åˆ»æ”¹å˜Reactç»„ä»¶ä¸­stateçš„å€¼ï¼›
* setStateé€šè¿‡å¼•å‘ä¸€æ¬¡ç»„ä»¶çš„æ›´æ–°è¿‡ç¨‹æ¥å¼•å‘é‡æ–°ç»˜åˆ¶ï¼›
* å¤šæ¬¡setStateå‡½æ•°è°ƒç”¨äº§ç”Ÿçš„æ•ˆæœä¼šåˆå¹¶ã€‚
* setState åªåœ¨åˆæˆäº‹ä»¶å’Œé’©å­å‡½æ•°ä¸­æ˜¯â€œå¼‚æ­¥â€çš„ï¼Œåœ¨åŸç”Ÿäº‹ä»¶å’ŒsetTimeout ä¸­éƒ½æ˜¯åŒæ­¥çš„ï¼Œæ‰¹é‡æ›´æ–°çš„ç­–ç•¥æ˜¯åŸºäº"å¼‚æ­¥"ä¹‹ä¸Šçš„ï¼Œåœ¨setTimeoutå’ŒåŸç”Ÿäº‹ä»¶ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œå› ä¸ºæ­¤æ—¶æ—¶ä¸å—æ§çš„
* setState çš„â€œå¼‚æ­¥â€å¹¶ä¸æ˜¯è¯´å†…éƒ¨ç”±å¼‚æ­¥ä»£ç å®ç°ï¼Œå…¶å®æœ¬èº«æ‰§è¡Œçš„è¿‡ç¨‹å’Œä»£ç éƒ½æ˜¯åŒæ­¥çš„ï¼Œåªæ˜¯åˆæˆäº‹ä»¶å’Œé’©å­å‡½æ•°çš„è°ƒç”¨é¡ºåºåœ¨æ›´æ–°ä¹‹å‰ï¼Œå¯¼è‡´åœ¨åˆæˆäº‹ä»¶å’Œé’©å­å‡½æ•°ä¸­æ²¡æ³•ç«‹é©¬æ‹¿åˆ°æ›´æ–°åçš„å€¼ï¼Œå½¢æˆäº†æ‰€è°“çš„â€œå¼‚æ­¥â€ï¼Œä½†æ˜¯å¦‚æœéœ€è¦ï¼Œä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆå¯ä»¥ç›´æ¥æ‹¿åˆ°æœ€æ–°çš„å€¼
* setState çš„æ‰¹é‡æ›´æ–°ä¼˜åŒ–ä¹Ÿæ˜¯å»ºç«‹åœ¨â€œå¼‚æ­¥â€ï¼ˆåˆæˆäº‹ä»¶ã€é’©å­å‡½æ•°ï¼‰ä¹‹ä¸Šçš„ï¼Œåœ¨åŸç”Ÿäº‹ä»¶å’ŒsetTimeout ä¸­ä¸ä¼šæ‰¹é‡æ›´æ–°ï¼Œåœ¨â€œå¼‚æ­¥â€ä¸­å¦‚æœå¯¹åŒä¸€ä¸ªå€¼è¿›è¡Œå¤šæ¬¡setStateï¼ŒsetStateçš„æ‰¹é‡æ›´æ–°ç­–ç•¥ä¼šå¯¹å…¶è¿›è¡Œè¦†ç›–ï¼Œå–æœ€åä¸€æ¬¡çš„æ‰§è¡Œï¼Œå¦‚æœæ˜¯åŒæ—¶setStateå¤šä¸ªä¸åŒçš„å€¼ï¼Œåœ¨æ›´æ–°æ—¶ä¼šå¯¹å…¶è¿›è¡Œåˆå¹¶æ‰¹é‡æ›´æ–°ã€‚
* åƒå†™å—æ§ç»„ä»¶é‚£æ ·å„¿å»æ“ä½œsetState













